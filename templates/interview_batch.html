<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω bu·ªïi ph·ªèng v·∫•n</title>
    <link rel="stylesheet" href="{{ base_path }}{{ url_for('static', filename='session_wizard.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border: none;
            background: none;
            color: #718096;
            font-weight: 600;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab:hover {
            color: #5a6ed0; /* M√†u primary-dark */
        }
        .tab.active {
            color: #667eea; /* M√†u primary */
            border-bottom-color: #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* ƒê·∫£m b·∫£o card-header cƒÉn ch·ªânh n√∫t t·∫£i l·∫°i */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>

    <script>
        let currentStep = 1;
        let sessionData = {
            vectorstore_id: null,
            topic: '',
            outline: [],
            session_name: '',
            config: {},
            candidates: []
        };
        let existingSessions = [];
        const basePath = window.location.pathname.startsWith('/iview1') ? '/iview1' : '';

        // H√ÄM CHUY·ªÇN TAB M·ªöI
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
            const tabContent = document.getElementById(`${tabName}-tab`);

            if (tabButton) tabButton.classList.add('active');
            if (tabContent) tabContent.classList.add('active');

            // C·∫≠p nh·∫≠t URL m√† kh√¥ng t·∫£i l·∫°i trang
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.pushState({}, '', url);
        }

        // --- Logic Wizard (Gi·ªØ nguy√™n) ---
        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));

            document.getElementById(`step${step}`).classList.add('active');
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');

            for (let i = 1; i < step; i++) {
                document.querySelector(`.step[data-step="${i}"]`).classList.add('completed');
            }
             for (let i = step + 1; i <= 4; i++) {
                document.querySelector(`.step[data-step="${i}"]`).classList.remove('completed');
            }

            currentStep = step;
            updateNavigationButtons();
        }

        function nextStep() {
            if (validateStep(currentStep)) {
                const next = currentStep + 1;
                goToStep(next);
                // if (next === 4) updatePreview(); // B·ªè qua v√¨ h√†m updatePreview r·ªóng
            }
        }

        function prevStep() {
            goToStep(currentStep - 1);
        }

        function validateStep(step) {
            switch(step) {
                case 1:
                    return validateKnowledge();
                case 2:
                    return validateSessionName();
                case 3:
                    return validateConfig();
                case 4:
                    return validateCandidates();
                default:
                    return true;
            }
        }

        function updateNavigationButtons() {
            document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'inline-flex';
            document.getElementById('nextBtn').style.display = currentStep === 4 ? 'none' : 'inline-flex';
            document.getElementById('createBtn').style.display = currentStep === 4 ? 'inline-flex' : 'none';
        }

        // --- Step 1: Knowledge (Gi·ªØ nguy√™n) ---
        async function loadVectorstores() {
            try {
                const response = await fetch(`${basePath}/interview_batch/vectorstores`);
                if (response.status === 401) {
                    const data = await response.json();
                    alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch t√†i li·ªáu');
                    window.location.href = data.redirect || `${basePath}/login`;
                    return;
                }
                const data = await response.json();
                const select = document.getElementById('vectorstoreSelect');
                select.innerHTML = '<option value="">-- Ch·ªçn t√†i li·ªáu --</option>';
                if (data.success && data.vectorstores.length > 0) {
                    data.vectorstores.forEach(vs => {
                        const option = document.createElement('option');
                        option.value = vs.id;
                        const tag = vs.is_public ? "üåç Chung" : "üë§ Ri√™ng";
                        option.textContent = `${vs.pdf_file} (${vs.num_chunks} ph√¢n ƒëo·∫°n) - ${tag}`;
                        option.dataset.topic = vs.topic;
                        select.appendChild(option);
                    });
                } else if (data.success && data.vectorstores.length === 0) {
                    select.innerHTML = '<option value="">B·∫°n ch∆∞a c√≥ t√†i li·ªáu n√†o. H√£y t·∫°o tr∆∞·ªõc!</option>';
                }
            } catch (error) {
                console.error('Error loading vectorstores:', error);
                alert('L·ªói t·∫£i danh s√°ch t√†i li·ªáu!');
            }
        }
        function onVectorstoreChange() {
            sessionData.vectorstore_id = document.getElementById('vectorstoreSelect').value;
        }
        function validateKnowledge() {
            sessionData.vectorstore_id = document.getElementById('vectorstoreSelect').value;
            sessionData.topic = document.getElementById('topicInput').value.trim();
            const outlineText = document.getElementById('outlineInput').value.trim();
            sessionData.outline = outlineText ? outlineText.split(',').map(s => s.trim()) : [];
            if (!sessionData.vectorstore_id) {
                alert('Vui l√≤ng ch·ªçn m·ªôt t√†i li·ªáu ki·∫øn th·ª©c!');
                return false;
            }
            if (!sessionData.topic) {
                alert('Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ cho bu·ªïi ph·ªèng v·∫•n!');
                return false;
            }
            return true;
        }

        // --- Step 2: Session Name (Gi·ªØ nguy√™n) ---
        function validateSessionName() {
            sessionData.session_name = document.getElementById('sessionName').value.trim();
            if (!sessionData.session_name) {
                alert('Vui l√≤ng nh·∫≠p t√™n cho bu·ªïi ph·ªèng v·∫•n!');
                return false;
            }
            return true;
        }

        // --- Step 3: Config (Gi·ªØ nguy√™n) ---
        function validateConfig() {
            const config = {
                threshold_high: parseFloat(document.getElementById('threshold_high').value),
                threshold_low: parseFloat(document.getElementById('threshold_low').value),
                max_attempts_per_level: parseInt(document.getElementById('max_attempts_per_level').value),
                max_total_questions: parseInt(document.getElementById('max_total_questions').value),
                max_upper_level: parseInt(document.getElementById('max_upper_level').value),
                llm_temperature: parseFloat(document.getElementById('llm_temperature').value),
                max_memory_turns: parseInt(document.getElementById('max_memory_turns').value)
            };
            if (config.threshold_high <= config.threshold_low) {
                alert('Ng∆∞·ª°ng tƒÉng ƒë·ªô kh√≥ ph·∫£i l·ªõn h∆°n ng∆∞·ª°ng gi·∫£m ƒë·ªô kh√≥!');
                return false;
            }
            sessionData.config = config;
            return true;
        }
        function loadDefaultConfig() {
            document.getElementById('threshold_high').value = 7.0;
            document.getElementById('threshold_low').value = 4.0;
            document.getElementById('max_attempts_per_level').value = 2;
            document.getElementById('max_total_questions').value = 8;
            document.getElementById('max_upper_level').value = 2;
            document.getElementById('llm_temperature').value = 0.5;
            document.getElementById('max_memory_turns').value = 6;
        }

        // --- Step 4: Candidates (Gi·ªØ nguy√™n) ---
        function setupFileUpload() {
            const dropArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');
            dropArea.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'));
            });
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'));
            });
            dropArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }
        function handleDrop(e) { handleFiles(e.dataTransfer.files); }
        function handleFileSelect(e) { handleFiles(e.target.files); }
        function handleFiles(files) {
            if (files.length === 0) return;
            const file = files[0];
            if (file.name.endsWith('.csv')) { readCSV(file); }
            else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) { readExcel(file); }
            else { alert('Ch·ªâ ch·∫•p nh·∫≠n file CSV ho·∫∑c Excel (.xlsx, .xls)!'); }
        }
        function readCSV(file) {
            const reader = new FileReader();
            reader.onload = (e) => parseCSV(e.target.result);
            reader.readAsText(file);
        }
        function parseCSV(csvText) {
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) { alert('‚ö†Ô∏è File CSV kh√¥ng h·ª£p l·ªá ho·∫∑c tr·ªëng!'); return; }
            const headers = lines[0].split(',').map(h => h.trim());
            const candidates = [];
            for (let i = 1; i < lines.length; i++) {
                const columns = lines[i].split(',').map(c => c.trim());
                if (columns.length === 0) continue;
                const candidate = {};
                headers.forEach((header, index) => { candidate[header] = columns[index] || ''; });
                candidates.push(candidate);
            }
            if (candidates.length === 0) { alert('‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong file CSV!'); return; }
            sessionData.candidates = candidates;
            displayCandidates();
        }
        function readExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    if (jsonData.length < 2) { alert('‚ö†Ô∏è File Excel kh√¥ng h·ª£p l·ªá ho·∫∑c tr·ªëng!'); return; }
                    const headers = jsonData[0];
                    const candidates = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        const candidate = {};
                        headers.forEach((header, index) => {
                            candidate[header] = row[index] !== undefined ? String(row[index]) : '';
                        });
                        candidates.push(candidate);
                    }
                    if (candidates.length === 0) { alert('‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong file Excel!'); return; }
                    sessionData.candidates = candidates;
                    displayCandidates();
                } catch (error) { console.error('Error reading Excel:', error); alert('‚ùå L·ªói ƒë·ªçc file Excel!'); }
            };
            reader.readAsArrayBuffer(file);
        }
        function displayCandidates() {
            const container = document.getElementById('candidateList');
            const placeholder = document.getElementById('candidateListPlaceholder');
            if (!sessionData.candidates || sessionData.candidates.length === 0) {
                container.innerHTML = '';
                placeholder.style.display = 'block';
                document.getElementById('candidateCount').textContent = 'Ch∆∞a c√≥ th√≠ sinh';
                return;
            }
            placeholder.style.display = 'none';
            const columns = Object.keys(sessionData.candidates[0]);
            let tableHTML = `<table class="candidate-table"><thead><tr>
                            ${columns.map(col => `<th>${col}</th>`).join('')}
                            <th>Thao t√°c</th>
                        </tr></thead><tbody>`;
            sessionData.candidates.forEach((candidate, index) => {
                tableHTML += `<tr>`;
                columns.forEach(col => { tableHTML += `<td>${candidate[col] || '-'}</td>`; });
                tableHTML += `<td>
                        <button class="btn-icon btn-danger" onclick="removeCandidate(${index})" title="X√≥a th√≠ sinh">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td></tr>`;
            });
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            document.getElementById('candidateCount').textContent = `ƒê√£ t·∫£i l√™n ${sessionData.candidates.length} th√≠ sinh`;
        }
        function removeCandidate(index) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√≠ sinh "${sessionData.candidates[index]['H·ªç t√™n h·ªçc vi√™n'] || 'n√†y'}"?`)) {
                sessionData.candidates.splice(index, 1);
                displayCandidates();
            }
        }
        function validateCandidates() {
            if (sessionData.candidates.length === 0) {
                alert('Vui l√≤ng t·∫£i l√™n danh s√°ch th√≠ sinh ƒë·ªÉ ti·∫øp t·ª•c!');
                return false;
            }
            return true;
        }
        function downloadTemplate() {
            const template = [
                ['STT', 'M√£ h·ªçc vi√™n', 'H·ªç t√™n h·ªçc vi√™n', 'Ng√†y sinh', 'Email', 'ƒêi·ªÉm 10%', 'ƒêi·ªÉm 40%'],
                ['1', '11244232', 'H√°n Ho√†i V√¢n An', '21/05/2006', '11244232@st.neu.edu.vn', '', ''],
                ['2', '11246248', 'Nguy·ªÖn Minh Anh', '20/02/2006', '11246248@st.neu.edu.vn', '', '']
            ];
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Danh s√°ch h·ªçc vi√™n');
            XLSX.writeFile(wb, 'DS_HocVien_Mau.xlsx');
        }

        // --- Preview and Create (Gi·ªØ nguy√™n logic) ---

        // H√ÄM R·ªñNG THEO Y√äU C·∫¶U
        function updatePreview() {
            // ƒê√£ comment trong file g·ªëc, ƒë·ªÉ tr·ªëng theo y√™u c·∫ßu
        }

        async function createInterviewSession() {
            // updatePreview(); // H√†m n√†y ƒë√£ r·ªóng
            if (!sessionData.vectorstore_id || !sessionData.topic || !sessionData.session_name || sessionData.candidates.length === 0) {
                alert('‚ùå Vui l√≤ng ho√†n thi·ªán ƒë·∫ßy ƒë·ªß th√¥ng tin ·ªü c√°c b∆∞·ªõc tr∆∞·ªõc!');
                return;
            }
            showLoading(true, 'ƒêang t·∫°o bu·ªïi ph·ªèng v·∫•n...');
            try {
                const response = await fetch(`${basePath}/interview_batch/create`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_name: sessionData.session_name,
                        config: sessionData.config,
                        candidates: sessionData.candidates,
                        vectorstore_id: sessionData.vectorstore_id,
                        topic: sessionData.topic,
                        outline: sessionData.outline
                    })
                });
                if (response.status === 401) { alert('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i'); window.location.href = `${basePath}/login`; return; }
                if (response.status === 403) { alert('B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠ d·ª•ng t√†i li·ªáu n√†y!'); return; }
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ T·∫°o bu·ªïi ph·ªèng v·∫•n th√†nh c√¥ng!');
                    window.location.href = `${basePath}/interview_batch`;
                } else {
                    alert('‚ùå L·ªói: ' + result.error);
                }
            } catch (error) {
                console.error('‚ùå Error creating session:', error);
                alert('‚ùå L·ªói t·∫°o bu·ªïi ph·ªèng v·∫•n: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // --- Existing Sessions (Gi·ªØ nguy√™n) ---
        async function loadExistingSessions() {
            try {
                const response = await fetch(`${basePath}/interview_batch/list`);
                if (response.status === 401) {
                    const data = await response.json();
                    window.location.href = data.redirect || `${basePath}/login`;
                    return;
                }
                const data = await response.json();
                if (data.success) {
                    existingSessions = data.sessions;
                    displayExistingSessions();
                }
            } catch (error) { console.error('Error loading sessions:', error); }
        }
        function displayExistingSessions() {
            const container = document.getElementById('existingSessionsList');
            if (existingSessions.length === 0) {
                container.innerHTML = '<p class="empty-placeholder"><i class="fas fa-folder-open"></i>Ch∆∞a c√≥ bu·ªïi ph·ªèng v·∫•n n√†o ƒë∆∞·ª£c t·∫°o.</p>';
                return;
            }
            container.innerHTML = existingSessions.map(session => {
                const progress = session.candidates.length > 0 ? (session.completed_count / session.candidates.length) * 100 : 0;
                return `
                <div class="session-card" onclick="selectSession('${session._id}')">
                    <div class="session-card-header">
                        <h4 class="session-card-title">${session.batch_name}</h4>
                         <span class="badge ${session.status === 'active' ? 'badge-active' : 'badge-completed'}">
                            ${session.status === 'active' ? 'ƒêang di·ªÖn ra' : 'ƒê√£ k·∫øt th√∫c'}
                        </span>
                    </div>
                    <div class="session-card-body">
                        <div class="session-meta"><i class="fas fa-book"></i> ${session.topic}</div>
                        <div class="session-meta"><i class="fas fa-users"></i> ${session.candidates.length} th√≠ sinh</div>
                        <div class="session-meta"><i class="fas fa-calendar-alt"></i> ${new Date(session.created_at).toLocaleString('vi-VN')}</div>
                    </div>
                    <div class="session-card-footer">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="progress-text">
                            ${session.completed_count} / ${session.candidates.length} ƒë√£ ho√†n th√†nh
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        function selectSession(sessionId) {
            window.location.href = `${basePath}/interview_batch/detail/${sessionId}`;
        }
        function showLoading(show, message = 'ƒêang x·ª≠ l√Ω...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            overlay.style.display = show ? 'flex' : 'none';
            if (text) text.textContent = message;
        }

        // --- Logic Auto-select (Gi·ªØ nguy√™n) ---
        function checkPreselectedVectorstore() {
            const preselected = sessionStorage.getItem('preselected_vectorstore');
            if (preselected) {
                try {
                    const data = JSON.parse(preselected);
                    const checkInterval = setInterval(() => {
                        const select = document.getElementById('vectorstoreSelect');
                        if (select.options.length > 1) { // ƒê·∫£m b·∫£o select ƒë√£ ƒë∆∞·ª£c load
                            clearInterval(checkInterval);
                            let found = false;
                            for (let i = 0; i < select.options.length; i++) {
                                if (select.options[i].value === data.id) {
                                    select.selectedIndex = i;
                                    onVectorstoreChange();
                                    if (data.topic) {
                                        document.getElementById('topicInput').value = data.topic;
                                        sessionData.topic = data.topic;
                                    }
                                    alert(`‚úÖ ƒê√£ t·ª± ƒë·ªông ch·ªçn t√†i li·ªáu: ${data.pdf_file}`);
                                    found = true;
                                    break;
                                }
                            }
                            // Ch·ªâ x√≥a n·∫øu t√¨m th·∫•y, n·∫øu kh√¥ng gi·ªØ l·∫°i ƒë·ªÉ th·ª≠ l·∫ßn sau
                            if(found) sessionStorage.removeItem('preselected_vectorstore');
                        }
                    }, 100);

                    // X√≥a sau 5 gi√¢y d√π c√≥ th√†nh c√¥ng hay kh√¥ng ƒë·ªÉ tr√°nh l·ªói
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        sessionStorage.removeItem('preselected_vectorstore');
                    }, 5000);
                } catch (e) {
                    console.error('Error parsing preselected vectorstore:', e);
                    sessionStorage.removeItem('preselected_vectorstore');
                }
            }
        }

        // THAY ƒê·ªîI: C·∫¨P NH·∫¨T DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // Kh·ªüi t·∫°o c√°c th√†nh ph·∫ßn
            loadDefaultConfig();
            setupFileUpload();
            loadVectorstores();     // Lu√¥n t·∫£i danh s√°ch vectorstores
            loadExistingSessions(); // Lu√¥n t·∫£i danh s√°ch sessions
            updateNavigationButtons(); // Kh·ªüi t·∫°o n√∫t cho wizard

            // X·ª≠ l√Ω logic chuy·ªÉn tab d·ª±a tr√™n URL
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');

            if (tabParam === 'create') {
                switchTab('create');
                // G·ªçi ki·ªÉm tra vectorstore ƒë√£ ch·ªçn n·∫øu ƒë∆∞·ª£c ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn tab 'create'
                checkPreselectedVectorstore();
            } else {
                // M·∫∑c ƒë·ªãnh l√† tab 'list'
                switchTab('list');
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-calendar-check"></i>
                    <span>Qu·∫£n l√Ω Bu·ªïi ph·ªèng v·∫•n</span>
                </div>
                <div class="header-actions">
                    <a href="{{ base_path }}/" class="btn btn-secondary">
                        <i class="fas fa-home"></i> Trang ch·ªß
                    </a>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="tabs">
                <button class="tab" data-tab="list" onclick="switchTab('list')">
                    <i class="fas fa-list-alt"></i> Danh s√°ch bu·ªïi ph·ªèng v·∫•n
                </button>
                <button class="tab" data-tab="create" onclick="switchTab('create')">
                    <i class="fas fa-plus-circle"></i> T·∫°o bu·ªïi ph·ªèng v·∫•n m·ªõi
                </button>
            </div>

            <div id="list-tab" class="tab-content">
                <div class="card" style="margin-bottom: 30px;">
                    <div class="card-header">
                        <h2><i class="fas fa-list-alt"></i> C√°c bu·ªïi ph·ªèng v·∫•n ƒë√£ t·∫°o</h2>
                        <button class="btn btn-secondary" onclick="loadExistingSessions()">
                            <i class="fas fa-sync"></i> T·∫£i l·∫°i
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="existingSessionsList" class="sessions-grid">
                           <p class="empty-placeholder"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i danh s√°ch...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="create-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-plus-circle"></i> T·∫°o bu·ªïi ph·ªèng v·∫•n m·ªõi</h2>
                    </div>
                    <div class="card-body">
                        <div class="session-wizard">
                            <div class="step-indicator">
                                <div class="step active" data-step="1">
                                    <div class="step-number">1</div>
                                    <div class="step-label">Ki·∫øn th·ª©c</div>
                                </div>
                                <div class="step" data-step="2">
                                    <div class="step-number">2</div>
                                    <div class="step-label">Th√¥ng tin</div>
                                </div>
                                <div class="step" data-step="3">
                                    <div class="step-number">3</div>
                                    <div class="step-label">C·∫•u h√¨nh</div>
                                </div>
                                <div class="step" data-step="4">
                                    <div class="step-number">4</div>
                                    <div class="step-label">Th√≠ sinh</div>
                                </div>
                            </div>

                            <div id="step1" class="step-content active">
                                <h3><i class="fas fa-book-open"></i> Ch·ªçn t√†i li·ªáu v√† ch·ªß ƒë·ªÅ ph·ªèng v·∫•n</h3>
                                <div class="form-group">
                                    <label for="vectorstoreSelect">T√†i li·ªáu ki·∫øn th·ª©c <span class="required">*</span></label>
                                    <select id="vectorstoreSelect" class="form-control" onchange="onVectorstoreChange()">
                                        <option value="">-- ƒêang t·∫£i danh s√°ch t√†i li·ªáu... --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="topicInput">Ch·ªß ƒë·ªÅ ph·ªèng v·∫•n <span class="required">*</span></label>
                                    <input type="text" id="topicInput" class="form-control" placeholder="V√≠ d·ª•: L·∫≠p tr√¨nh h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng trong Java">
                                </div>
                                <div class="form-group">
                                    <label for="outlineInput">N·ªôi dung chi ti·∫øt (t√πy ch·ªçn)</label>
                                    <input type="text" id="outlineInput" class="form-control" placeholder="V√≠ d·ª•: T√≠nh ƒë√≥ng g√≥i, K·∫ø th·ª´a, ƒêa h√¨nh, Tr·ª´u t∆∞·ª£ng">
                                    <small>C√°c n·ªôi dung li√™n quan, ngƒÉn c√°ch b·ªüi d·∫•u ph·∫©y, gi√∫p h·ªá th·ªëng truy xu·∫•t ki·∫øn th·ª©c t·ªët h∆°n.</small>
                                </div>
                            </div>

                            <div id="step2" class="step-content">
                                <h3><i class="fas fa-tag"></i> ƒê·∫∑t t√™n cho bu·ªïi ph·ªèng v·∫•n</h3>
                                <div class="form-group">
                                    <label for="sessionName">T√™n bu·ªïi ph·ªèng v·∫•n <span class="required">*</span></label>
                                    <input type="text" id="sessionName" class="form-control" placeholder="V√≠ d·ª•: ƒê√°nh gi√° Java Core - L·ªõp K65-CNTT1">
                                    <small>T√™n n√†y s·∫Ω gi√∫p b·∫°n d·ªÖ d√†ng qu·∫£n l√Ω v√† t√¨m ki·∫øm c√°c bu·ªïi ph·ªèng v·∫•n.</small>
                                </div>
                            </div>

                            <div id="step3" class="step-content">
                                <h3><i class="fas fa-cogs"></i> C·∫•u h√¨nh tham s·ªë ph·ªèng v·∫•n</h3>
                                <div class="config-grid">
                                    <div class="form-group">
                                        <label for="threshold_high">Ng∆∞·ª°ng tƒÉng ƒë·ªô kh√≥</label>
                                        <input type="number" id="threshold_high" class="form-control" step="0.1" min="0" max="10">
                                        <small>ƒêi·ªÉm s·ªë >= ng∆∞·ª°ng n√†y s·∫Ω tƒÉng ƒë·ªô kh√≥ c√¢u h·ªèi.</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="threshold_low">Ng∆∞·ª°ng gi·∫£m ƒë·ªô kh√≥</label>
                                        <input type="number" id="threshold_low" class="form-control" step="0.1" min="0" max="10">
                                        <small>ƒêi·ªÉm s·ªë <= ng∆∞·ª°ng n√†y s·∫Ω gi·∫£m ƒë·ªô kh√≥.</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="max_attempts_per_level">S·ªë c√¢u t·ªëi ƒëa / m·ª©c</label>
                                        <input type="number" id="max_attempts_per_level" class="form-control" min="1">
                                        <small>S·ªë c√¢u h·ªèi t·ªëi ƒëa cho m·ªói m·ª©c ƒë·ªô kh√≥.</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="max_total_questions">T·ªïng s·ªë c√¢u h·ªèi</label>
                                        <input type="number" id="max_total_questions" class="form-control" min="1">
                                        <small>T·ªïng s·ªë c√¢u h·ªèi t·ªëi ƒëa cho m·ªôt th√≠ sinh.</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="max_upper_level">S·ªë l·∫ßn tƒÉng ƒë·ªô kh√≥</label>
                                        <input type="number" id="max_upper_level" class="form-control" min="1">
                                        <small>S·ªë l·∫ßn tƒÉng ƒë·ªô kh√≥ t·ªëi ƒëa trong m·ªôt l∆∞·ª£t.</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="llm_temperature">ƒê·ªô s√°ng t·∫°o c·ªßa AI</label>
                                        <input type="number" id="llm_temperature" class="form-control" step="0.1" min="0" max="2">
                                        <small>0 = logic, 1 = s√°ng t·∫°o. Khuy·∫øn ngh·ªã: 0.5</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="max_memory_turns">B·ªô nh·ªõ h·ªôi tho·∫°i</label>
                                        <input type="number" id="max_memory_turns" class="form-control" min="1">
                                        <small>S·ªë l∆∞·ª£t tr√≤ chuy·ªán AI s·∫Ω ghi nh·ªõ.</small>
                                    </div>
                                </div>
                            </div>

                            <div id="step4" class="step-content">
                                <h3><i class="fas fa-users"></i> T·∫£i l√™n danh s√°ch th√≠ sinh</h3>
                                <div class="template-download">
                                    <i class="fas fa-info-circle"></i>
                                    <div>
                                        <strong>S·ª≠ d·ª•ng file m·∫´u ƒë·ªÉ ƒë·∫£m b·∫£o ƒë√∫ng ƒë·ªãnh d·∫°ng</strong>
                                        <p>T·∫£i xu·ªëng file Excel m·∫´u v√† ƒëi·ªÅn th√¥ng tin th√≠ sinh c·ªßa b·∫°n.</p>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="downloadTemplate()">
                                            <i class="fas fa-download"></i> T·∫£i file m·∫´u
                                        </button>
                                    </div>
                                </div>
                                <div id="fileUploadArea" class="file-upload-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <h4>K√©o & th·∫£ file Excel/CSV v√†o ƒë√¢y</h4>
                                    <p>ho·∫∑c <strong>b·∫•m ƒë·ªÉ ch·ªçn file</strong> t·ª´ m√°y t√≠nh</p>
                                    <small>H·ªó tr·ª£ ƒë·ªãnh d·∫°ng: .xlsx, .xls, .csv</small>
                                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                                </div>
                                <div class="candidate-list-container">
                                    <h4 id="candidateCount">Ch∆∞a c√≥ th√≠ sinh</h4>
                                    <div id="candidateList"></div>
                                    <div id="candidateListPlaceholder" class="empty-placeholder">
                                        <i class="fas fa-user-friends"></i>
                                        Danh s√°ch th√≠ sinh s·∫Ω hi·ªán ·ªü ƒë√¢y sau khi b·∫°n t·∫£i file l√™n.
                                    </div>
                                </div>
                            </div>

                            <div class="btn-group">
                                <button id="prevBtn" class="btn btn-secondary" onclick="prevStep()">
                                    <i class="fas fa-arrow-left"></i> Quay l·∫°i
                                </button>
                                <button id="nextBtn" class="btn btn-primary" onclick="nextStep()">
                                    Ti·∫øp theo <i class="fas fa-arrow-right"></i>
                                </button>
                                <button id="createBtn" class="btn btn-success" onclick="createInterviewSession()" style="display: none;">
                                    <i class="fas fa-check-circle"></i> Ho√†n t·∫•t v√† T·∫°o bu·ªïi ph·ªèng v·∫•n
                                </button>
                            </div>
                        </div> </div>
                </div>
            </div> </main>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div id="loadingText" class="loading-text">ƒêang x·ª≠ l√Ω...</div>
    </div>
</body>
</html>