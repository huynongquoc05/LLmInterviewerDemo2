{% extends "base.html" %}

{% block title %}Chi ti·∫øt Vectorstore - AI Interviewer{% endblock %}

{% block head %}
  <style>
    /* --- 1. Thi·∫øt l·∫≠p Bi·∫øn & Giao di·ªán T·ªïng th·ªÉ --- */
    :root {
      --primary: #0d6efd;
      --primary-dark: #0b5ed7;
      --green: #198754; /* S·ª≠ d·ª•ng m√†u xanh l√° c√¢y ƒë·∫≠m h∆°n */
      --green-dark: #157347;
      --text-dark: #212529;
      --text-light: #6c757d;
      /* --bg-body ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ·ªü base.html (l√† #f8f9fa) -- */
      --bg-card: #ffffff;
      --border-color: #e9ecef;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      --card-shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.08);
      --border-radius: 10px; /* Th·ªëng nh·∫•t bo g√≥c */
    }

    /* --- 2. Ti√™u ƒë·ªÅ & Ph√¢n c·∫•p --- */
    .page-header {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1.5rem;
      margin-bottom: 1.5rem !important;
    }

    .page-header h2 .fa-database {
       color: var(--primary);
    }

    h2, h4 {
      font-weight: 600;
    }

    /* --- 3. N√∫t B·∫•m (Buttons) --- */
    .btn {
      border-radius: 8px;
      font-weight: 600;
      padding: 0.6rem 1.2rem;
      border: none;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .btn:hover {
       transform: translateY(-2px);
       box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* N√∫t ch√≠nh: T·∫°o ph·ªèng v·∫•n */
    .btn-create-interview {
      background: var(--green);
      color: white;
    }
    .btn-create-interview:hover {
      background: var(--green-dark);
      color: white;
      box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3); /* ƒê·ªï b√≥ng m√†u xanh */
    }

    /* N√∫t ph·ª•: Hi·ªÉn th·ªã Chunks */
    .btn-custom {
      background: var(--primary);
      color: white;
    }
    .btn-custom:hover {
      background: var(--primary-dark);
      color: white;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3); /* ƒê·ªï b√≥ng m√†u xanh */
    }

    /* N√∫t Quay l·∫°i (Ghi ƒë√® .btn-secondary t·ª´ base/styles.css n·∫øu c·∫ßn) */
    .btn-secondary {
        background-color: var(--bg-card);
        color: var(--text-light);
        border: 1px solid var(--border-color);
    }
    .btn-secondary:hover {
        background-color: #f1f3f5;
        color: var(--text-dark);
        border-color: #dee2e6;
    }

    .action-buttons {
      display: flex;
      gap: 12px; /* TƒÉng kho·∫£ng c√°ch */
      margin-bottom: 25px; /* Th√™m kho·∫£ng c√°ch d∆∞·ªõi */
    }

    /* --- 4. Th·∫ª Metadata --- */
    .card {
      border: none;
      box-shadow: var(--card-shadow);
      border-radius: var(--border-radius);
      background: var(--bg-card);
    }

    .info-table th {
      width: 180px; /* Cho ph√©p n·ªôi dung linh ho·∫°t h∆°n */
      color: var(--text-light); /* L√†m d·ªãu m√†u ch·ªØ */
      font-weight: 600;
      border-top: none;
      padding: 1rem 0.75rem;
      vertical-align: top;
    }

    .info-table td {
      font-weight: 500;
      color: var(--text-dark);
      border-top: none;
      padding: 1rem 0.75rem;
    }

    /* Th√™m ƒë∆∞·ªùng k·∫ª ngang tinh t·∫ø gi·ªØa c√°c h√†ng */
    .info-table tr {
        border-bottom: 1px solid var(--border-color);
    }
    .info-table tr:last-child {
        border-bottom: none;
    }

    .info-table a {
        font-weight: 600;
        text-decoration: none;
    }
    .info-table a:hover {
        text-decoration: underline;
    }

    /* --- 5. Th·∫ª Chunk --- */
    .chunk-card {
      background: var(--bg-card);
      padding: 20px;
      margin-bottom: 16px;
      border-radius: var(--border-radius);
      border-left: 5px solid var(--primary);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      transition: all 0.3s ease;
    }

    .chunk-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-shadow-hover);
    }

    .chunk-card strong {
        font-size: 1.1rem;
        color: var(--primary);
    }

    /* Kh·ªëi `pre` (hi·ªÉn th·ªã n·ªôi dung chunk) */
    pre {
      background: #f1f3f5; /* N·ªÅn x√°m nh·∫°t h∆°n */
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #495057;
      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 0.9em;
      margin-top: 12px;
      line-height: 1.7; /* TƒÉng ƒë·ªô d√£n d√≤ng */
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4 page-header">
    <h2><i class="fa-solid fa-database me-2"></i>Chi ti·∫øt Vectorstore</h2>
    <a href="{{ base_path }}/embedding?tab=list" class="btn btn-secondary">
        <i class="fa-solid fa-arrow-left me-2"></i>Quay l·∫°i
    </a>
  </div>

  <div class="action-buttons">
    <button class="btn btn-create-interview" id="createInterviewBtn">
      <i class="fa-solid fa-calendar-plus me-2"></i>T·∫°o bu·ªïi ph·ªèng v·∫•n v·ªõi t√†i li·ªáu n√†y
    </button>
  </div>

  <div id="meta" class="card p-3 mb-4">
    <div class="text-center text-secondary p-4">
      <i class="fa-solid fa-spinner fa-spin me-2"></i>ƒêang t·∫£i metadata...
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3 mt-5"> <h4><i class="fa-solid fa-layer-group me-2 text-secondary"></i>C√°c Chunks</h4>
    <button class="btn btn-custom" id="showChunksBtn">
      <i class="fa-solid fa-eye me-2"></i>Hi·ªÉn th·ªã c√°c ph√¢n ƒëo·∫°n <button>
  </div>

  <div id="chunks"></div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    const vectorstoreId = "{{ vectorstore_id }}";
    const basePath = window.location.pathname.startsWith('/iview1') ? '/iview1' : '';
    let vectorstoreData = null;

    // üß© Hi·ªÉn th·ªã metadata
    fetch(`${basePath}/embedding/info/${vectorstoreId}`)
      .then(res => res.json())
      .then(data => {
        if (!data.success) throw new Error(data.error);
        vectorstoreData = data.vectorstore;
        const vs = data.vectorstore;
        const meta = document.getElementById('meta');
        const createdAt = new Date(vs.created_at?.$date || vs.created_at).toLocaleString("vi-VN");

        // Thay ƒë·ªïi nh·ªè: X√≥a padding (p-3) c·ªßa card v√† th√™m table-borderless
        meta.classList.remove('p-3');
        meta.innerHTML = `
          <table class="table info-table mb-0">
            <tr><th>ID</th><td>${vs._id?.$oid || 'N/A'}</td></tr>
            <tr><th>T√™n Vectorstore</th><td>${vs.vectorstore_name}</td></tr>
            <tr>
              <th>PDF g·ªëc</th>
              <td>
                <i class="fa-regular fa-file-pdf text-danger me-1"></i>
                <a href="${basePath}${vs.custom?.original_path?.includes('uploads')
                  ? vs.custom.original_path.replace(/^[\\/]+/, '/').replace(/\\/g, '/')
                  : '/uploads/' + vs.custom.original_path.replace(/^[\\/]+/, '').replace(/\\/g, '/')}"
                   target="_blank">
                  ${vs.pdf_file}
                </a>
              </td>
            </tr>
            <tr><th>S·ªë l∆∞·ª£ng trang</th><td>${vs.num_pages}</td></tr>
            <tr><th>K√≠ch th∆∞·ªõc file</th><td>${vs.file_size_mb.toFixed(2)} MB</td></tr>
            <tr><th>S·ªë l∆∞·ª£ng ph√¢n ƒëo·∫°n ƒë∆∞·ª£c t√°ch sau khi x·ª≠ l√Ω</th><td>${vs.num_chunks}</td></tr>
            <tr><th>Model</th><td>${vs.model_info?.name || vs.model_name}</td></tr>
            <tr><th>Ng√¥n ng·ªØ h·ªó tr·ª£</th><td>${vs.model_info?.languages?.join(', ') || '-'}</td></tr>
            <tr><th>M√¥ t·∫£ model</th><td>${vs.model_info?.description || '-'}</td></tr>
            <tr><th>Chi·∫øn l∆∞·ª£c t√°ch ƒëo·∫°n</th><td>${vs.splitter_strategy}</td></tr>
            <tr><th>Chunk size / overlap</th><td>${vs.chunk_size} / ${vs.chunk_overlap}</td></tr>
            <tr><th>Tr·∫°ng th√°i</th><td><span class="badge bg-success">${vs.status}</span></td></tr>
            <tr><th>Ng√†y t·∫°o</th><td>${createdAt}</td></tr>
          </table>
        `;
      })
      .catch(err => {
        document.getElementById('meta').innerHTML =
          `<div class="alert alert-danger m-3">L·ªói t·∫£i metadata: ${err}</div>`;
      });

    // üìÑ N√∫t hi·ªÉn th·ªã chunks
    document.getElementById('showChunksBtn').addEventListener('click', () => {
      const btn = document.getElementById('showChunksBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>ƒêang t·∫£i...';

      fetch(`${basePath}/embedding/chunks/${vectorstoreId}`)
        .then(res => res.json())
        .then(data => {
          if (!data.success) throw new Error(data.error);
          const container = document.getElementById('chunks');
          container.innerHTML = data.chunks.map(chunk => `
            <div class="chunk-card">
              <div class="d-flex justify-content-between">
                <strong>Chunk #${chunk.index}</strong>
                <span class="text-muted small">${(chunk.content.length / 1600 * 100).toFixed(0)}% ƒë·ªô d√†i</span>
              </div>
              <pre>${chunk.content}</pre>
            </div>
          `).join('');
        })
        .catch(err => alert('L·ªói t·∫£i chunks: ' + err))
        .finally(() => {
          btn.disabled = false;
          btn.innerHTML = '<i class="fa-solid fa-eye me-2"></i>Hi·ªÉn th·ªã c√°c chunks';
        });
    });

    // ‚úÖ N√∫t t·∫°o bu·ªïi ph·ªèng v·∫•n
    document.getElementById('createInterviewBtn').addEventListener('click', () => {
      if (!vectorstoreData) {
        alert('Vui l√≤ng ƒë·ª£i t·∫£i xong th√¥ng tin t√†i li·ªáu!');
        return;
      }

      sessionStorage.setItem('preselected_vectorstore', JSON.stringify({
        id: vectorstoreData._id?.$oid || vectorstoreData._id,
        name: vectorstoreData.vectorstore_name,
        pdf_file: vectorstoreData.pdf_file,
        num_chunks: vectorstoreData.num_chunks,
        topic: vectorstoreData.topic || ''
      }));

      // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang t·∫°o bu·ªïi ph·ªèng v·∫•n V√Ä ch·ªçn s·∫µn tab 'create'
      window.location.href = `${basePath}/interview_batch?tab=create`;
    });
  </script>
{% endblock %}